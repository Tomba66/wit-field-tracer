<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Workday Integration Launcher</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      max-width: 600px;
      margin: auto;
      background: #f7f7f7;
    }
    h1 {
      text-align: center;
    }
    select, button {
      padding: 0.5rem;
      font-size: 1rem;
      margin: 0.5rem 0;
    }
    #status {
      margin-top: 1rem;
      padding: 1rem;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
      min-height: 2rem;
    }
  </style>
</head>
<body>

  <h1>üöÄ Workday Integration Launcher</h1>

  <label for="envSelect">Select Environment:</label>
  <select id="envSelect">
    <option value="PRODUCTION">Production</option>
    <option value="SANDBOX">Sandbox</option>
  </select>

  <br/>

  <button id="loginBtn">üîê Log In</button>
  <button id="launchBtn" disabled>üì§ Launch Integration</button>

  <div id="status">Not authenticated</div>

  <script>
    // === Configuration ===
    const config = {
      redirectUri: "https://tomba66.github.io/wit-field-tracer/redirect-github.html",  // REPLACE with your actual redirect.html location
      environments: {
        PRODUCTION: {
		  tenantId: "idmcompanies_preview",
          clientId: "MzQ4NDI4MmItMjNiZC00MDRkLWE2MzgtZTkzZDMxMDcxOGIx",
          authEndpoint: "https://impl.workday.com/idmcompanies_preview/authorize",
          tokenEndpoint: "https://wd2-impl-services1.workday.com/ccx/oauth2/idmcompanies_preview/token",
          launchUrl: "https://e2-impl-cci.workday.com/ccx/cc-cloud-repo/launches/Test_Date/Test_Date/Test_Date_Listener"
        },
        SANDBOX: {
		  tenantId: "idmcompanies_preview",
          clientId: "MzQ4NDI4MmItMjNiZC00MDRkLWE2MzgtZTkzZDMxMDcxOGIx",
          authEndpoint: "https://impl.workday.com/idmcompanies_preview/authorize",
          tokenEndpoint: "https://wd2-impl-services1.workday.com/ccx/oauth2/idmcompanies_preview/token",
          launchUrl: "https://e2-impl-cci.workday.com/ccx/cc-cloud-repo/launches/Test_Date/Test_Date/Test_Date_Listener"
        }
      }
    };

    // === Globals ===
    let accessToken = "";
    let selectedEnv = "PRODUCTION";

    // === DOM Elements ===
    const loginBtn = document.getElementById("loginBtn");
    const launchBtn = document.getElementById("launchBtn");
    const envSelect = document.getElementById("envSelect");
    const statusDiv = document.getElementById("status");

    // === Helper Functions ===
    function updateStatus(text) {
      statusDiv.textContent = text;
    }

    function base64urlEncode(buffer) {
      return btoa(String.fromCharCode(...new Uint8Array(buffer)))
        .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
    }

    // === OAuth Step 1: Start Login ===
    async function startOAuthLogin() {
      selectedEnv = envSelect.value;
      const env = config.environments[selectedEnv];

      const verifier = base64urlEncode(crypto.getRandomValues(new Uint8Array(32)));
      localStorage.setItem("code_verifier", verifier);

      const encoder = new TextEncoder();
      const data = encoder.encode(verifier);
      const digest = await crypto.subtle.digest("SHA-256", data);
      const challenge = base64urlEncode(digest);

      const authUrl = `${env.authEndpoint}?response_type=code&client_id=${encodeURIComponent(env.clientId)}&redirect_uri=${encodeURIComponent(config.redirectUri)}&code_challenge=${challenge}&code_challenge_method=S256`;

      window.open(authUrl, "_blank", "width=600,height=700");
    }

    // === OAuth Step 2: Token Exchange ===
    async function exchangeToken(code) {
      const env = config.environments[selectedEnv];
      const verifier = localStorage.getItem("code_verifier");

      const formData = new URLSearchParams();
      formData.append("grant_type", "authorization_code");
      formData.append("client_id", env.clientId);
      formData.append("redirect_uri", config.redirectUri);
      formData.append("code_verifier", verifier);
      formData.append("code", code);

      try {
        const res = await fetch(env.tokenEndpoint, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: formData
        });

        const tokenData = await res.json();
        if (tokenData.access_token) {
           sessionStorage.setItem("access_token", tokenData.access_token);
          updateStatus("‚úÖ Authenticated. You can now launch the integration.");
          launchBtn.disabled = false;
        } else {
          updateStatus("‚ùå Token error.");
          console.error("Token exchange failed:", tokenData);
        }
      } catch (err) {
        updateStatus("‚ùå Network error during token exchange.");
        console.error(err);
      }
    }

    // === Step 3: Launch Integration ===
async function launchIntegration() {
  const selectedEnv = document.getElementById("envSelect").value;
  const env = config.environments[selectedEnv];
  const accessToken = sessionStorage.getItem("access_token");
  console.log("Message: ", "Launch integration function triggered");
  if (!accessToken) {
    updateStatus("‚ùå Not authenticated. Please log in first.");
    return;
  }

  const proxyUrl = "https://workday-cors-proxy.netlify.app/.netlify/functions/proxy";

  updateStatus("üöÄ Launching integration...");

  try {
    const proxyRequest = {
      targetUrl: env.launchUrl,
      method: "POST",
      headers: {
        "Authorization": `Bearer ${accessToken}`,
        "X-Tenant": env.tenantId.toLowerCase(),
        "Content-Type": "text/plain"
      },
      body: ""  // No payload required for standard Workday launches
    };

    const response = await fetch(proxyUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(proxyRequest)
    });

	const responseText = await response.text();  // Read raw response as text

  if (!response.ok) {
    updateStatus(`‚ùå Launch failed. HTTP ${response.status} ${response.statusText}`);
    console.error("‚ùå Workday Launch Error:", {
      status: response.status,
      statusText: response.statusText,
      responseText
    });
    return;
  }
  console.log("‚úÖ Workday Launch Response (raw):", responseText);

  // Parse XML from Workday launch response
  const parser = new DOMParser();
  const xmlDoc = parser.parseFromString(responseText, "application/xml");
  const eventRef = xmlDoc.querySelector("integration-system-launch > business-process-reference")?.textContent;

  if (!eventRef) {
    updateStatus("‚ùå Failed to extract event reference from Workday response.");
    return;
  }

  updateStatus("üöÄ Integration launched. Monitoring status...");
  monitorIntegrationStatus(eventRef, accessToken);  // Call your monitoring logic here

} catch (err) {
  updateStatus("‚ùå Network error during launch.");
  console.error("‚ùå Launch error:", err);
}
}

async function monitorIntegrationStatus(eventWID, accessToken) {
  const soapBody = `
    <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:bsvc="urn:com.workday/bsvc">
      <soapenv:Header>
        <bsvc:Workday_Common_Header>
          <bsvc:Include_Reference_Descriptors_In_Response>1</bsvc:Include_Reference_Descriptors_In_Response>
        </bsvc:Workday_Common_Header>
      </soapenv:Header>
      <soapenv:Body>
        <bsvc:Get_Event_Details_Request bsvc:version="v44.1">
          <bsvc:Request_References>
            <bsvc:Event_Reference>
              <bsvc:ID bsvc:type="WID">${eventWID}</bsvc:ID>
            </bsvc:Event_Reference>
          </bsvc:Request_References>
        </bsvc:Get_Event_Details_Request>
      </soapenv:Body>
    </soapenv:Envelope>
  `.trim();

  const proxyUrl = "https://workday-cors-proxy.netlify.app/.netlify/functions/proxy";
  const soapUrl = "https://wd2-impl-services1.workday.com/ccx/service/idmcompanies_preview/Integrations/v44.1";

  let attempt = 0;
  const maxAttempts = 10;

  const intervalId = setInterval(async () => {
    attempt++;
    updateStatus(`üîÑ Checking status (Attempt ${attempt})...`);

    const proxyRequest = {
      targetUrl: soapUrl,
      method: "POST",
      headers: {
        "Authorization": `Bearer ${accessToken}`,
        "Content-Type": "text/xml"
      },
      body: soapBody
    };

    try {
      const res = await fetch(proxyUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(proxyRequest)
      });

      const text = await res.text();
      const xml = new DOMParser().parseFromString(text, "application/xml");
      const status = xml.querySelector("wd\\:Event_State_Reference")?.getAttribute("wd:Descriptor");

      if (status) {
        updateStatus(`üìÑ Integration Status: ${status}`);
        if (status.toLowerCase() === "completed" || status.toLowerCase() === "canceled" || status.toLowerCase() === "failed") {
          clearInterval(intervalId);
        }
      } else {
        updateStatus(`‚ùì Could not determine integration status (Attempt ${attempt})`);
      }

      if (attempt >= maxAttempts) {
        clearInterval(intervalId);
        updateStatus("‚ö†Ô∏è Stopped monitoring after maximum attempts.");
      }

    } catch (err) {
      console.error("SOAP status check failed:", err);
      updateStatus("‚ùå Failed to check integration status.");
      clearInterval(intervalId);
    }
  }, 30000); // every 30 seconds
}


    // === Step 5: Download Deliverable ===
    async function downloadDeliverable(env, processId) {
      try {
        const res = await fetch(`${env.launchUrl}/${processId}/output`, {
          headers: {
            Authorization: `Bearer ${accessToken}`,
            "X-Tenant": env.tenantId.toLowerCase()
          }
        });

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `workday_output_${Date.now()}.html`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        updateStatus("üì• File downloaded successfully.");
      } catch (err) {
        updateStatus("‚ö†Ô∏è Failed to download output.");
        console.error(err);
      }
    }

    // === Event Listeners ===
    loginBtn.addEventListener("click", startOAuthLogin);
    launchBtn.addEventListener("click", launchIntegration);

    window.addEventListener("message", (event) => {
      const { type, code } = event.data || {};
      if (type === "oauth-code" && code) {
        exchangeToken(code);
      }
    });
  </script>
</body>
</html>
