<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Workday Integration Launcher</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      max-width: 600px;
      margin: auto;
      background: #f7f7f7;
    }
    h1 {
      text-align: center;
    }
    select, button {
      padding: 0.5rem;
      font-size: 1rem;
      margin: 0.5rem 0;
    }
    #status {
      margin-top: 1rem;
      padding: 1rem;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
      min-height: 2rem;
    }
  </style>
</head>
<body>

  <h1>üöÄ Workday Integration Launcher</h1>

  <label for="envSelect">Select Environment:</label>
  <select id="envSelect">
    <option value="PRODUCTION">Production</option>
    <option value="SANDBOX">Sandbox</option>
  </select>

  <br/>

  <button id="loginBtn">üîê Log In</button>
  <button id="launchBtn" disabled>üì§ Launch Integration</button>

  <div id="status">Not authenticated</div>

  <script>
    // === Configuration ===
    const config = {
      redirectUri: "https://tomba66.github.io/wit-field-tracer/redirect-github.html",  // REPLACE with your actual redirect.html location
      environments: {
        PRODUCTION: {
          clientId: "MzQ4NDI4MmItMjNiZC00MDRkLWE2MzgtZTkzZDMxMDcxOGIx",
          authEndpoint: "https://impl.workday.com/idmcompanies_preview/authorize",
          tokenEndpoint: "https://wd2-impl-services1.workday.com/ccx/oauth2/idmcompanies_preview/token",
          launchUrl: "https://e2-impl-cci.workday.com/ccx/cc-cloud-repo/launches/Test_Date/Test_Date/Test_Date_Listener"
        },
        SANDBOX: {
          clientId: "MzQ4NDI4MmItMjNiZC00MDRkLWE2MzgtZTkzZDMxMDcxOGIx",
          authEndpoint: "https://impl.workday.com/idmcompanies_preview/authorize",
          tokenEndpoint: "https://wd2-impl-services1.workday.com/ccx/oauth2/idmcompanies_preview/token",
          launchUrl: "https://e2-impl-cci.workday.com/ccx/cc-cloud-repo/launches/Test_Date/Test_Date/Test_Date_Listener"
        }
      }
    };

    // === Globals ===
    let accessToken = "";
    let selectedEnv = "PRODUCTION";

    // === DOM Elements ===
    const loginBtn = document.getElementById("loginBtn");
    const launchBtn = document.getElementById("launchBtn");
    const envSelect = document.getElementById("envSelect");
    const statusDiv = document.getElementById("status");

    // === Helper Functions ===
    function updateStatus(text) {
      statusDiv.textContent = text;
    }

    function base64urlEncode(buffer) {
      return btoa(String.fromCharCode(...new Uint8Array(buffer)))
        .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
    }

    // === OAuth Step 1: Start Login ===
    async function startOAuthLogin() {
      selectedEnv = envSelect.value;
      const env = config.environments[selectedEnv];

      const verifier = base64urlEncode(crypto.getRandomValues(new Uint8Array(32)));
      localStorage.setItem("code_verifier", verifier);

      const encoder = new TextEncoder();
      const data = encoder.encode(verifier);
      const digest = await crypto.subtle.digest("SHA-256", data);
      const challenge = base64urlEncode(digest);

      const authUrl = `${env.authEndpoint}?response_type=code&client_id=${encodeURIComponent(env.clientId)}&redirect_uri=${encodeURIComponent(config.redirectUri)}&code_challenge=${challenge}&code_challenge_method=S256`;

      window.open(authUrl, "_blank", "width=600,height=700");
    }

    // === OAuth Step 2: Token Exchange ===
    async function exchangeToken(code) {
      const env = config.environments[selectedEnv];
      const verifier = localStorage.getItem("code_verifier");

      const formData = new URLSearchParams();
      formData.append("grant_type", "authorization_code");
      formData.append("client_id", env.clientId);
      formData.append("redirect_uri", config.redirectUri);
      formData.append("code_verifier", verifier);
      formData.append("code", code);

      try {
        const res = await fetch(env.tokenEndpoint, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: formData
        });

        const data = await res.json();
        if (data.access_token) {
          accessToken = data.access_token;
          updateStatus("‚úÖ Authenticated. You can now launch the integration.");
          launchBtn.disabled = false;
        } else {
          updateStatus("‚ùå Token error.");
          console.error("Token exchange failed:", data);
        }
      } catch (err) {
        updateStatus("‚ùå Network error during token exchange.");
        console.error(err);
      }
    }

    // === Step 3: Launch Integration ===
    async function launchIntegration() {
      const env = config.environments[selectedEnv];

      updateStatus("üöÄ Launching integration...");

      try {
/*
const proxiedUrl = "https://cors-anywhere.herokuapp.com/" + env.launchUrl;
const res = await fetch(proxiedUrl, {
  method: "POST",
  headers: {
    Authorization: `Bearer ${accessToken}`,
    "X-Tenant":"idmcompanies_preview",
    "Content-Type": "text/plain; charset=utf-8"
  }
});
*/
const res = await fetch(env.launchUrl, {
  mode: "no-cors",
  method: "POST",
  headers: {
    Authorization: `Bearer ${accessToken}`,
    "X-Tenant": "idmcompanies_preview", 
    "Content-Type": "text/plain; charset=utf-8"
  }
});

        const result = await res.json();
        const procId = result?.id || result?.event?.id || null;

        if (!procId) {
          updateStatus("‚ö†Ô∏è Launched, but process ID not found.");
          return;
        }

        updateStatus("‚è≥ Integration launched. Monitoring progress...");

        await pollStatus(env, procId);
      } catch (err) {
        updateStatus("‚ùå Failed to launch integration.");
        console.error(err);
      }
    }

    // === Step 4: Polling ===
    async function pollStatus(env, processId) {
      let checks = 0;
      const maxChecks = 10;
      const delay = 30000;

      while (checks < maxChecks) {
        updateStatus(`üîÑ Checking status (Attempt ${checks + 1})...`);

        try {
          const res = await fetch(`${env.launchUrl}/${processId}`, {
            headers: {
              Authorization: `Bearer ${accessToken}`,
              "X-Tenant": selectedEnv.toLowerCase()
            }
          });

          const data = await res.json();
          const status = data?.status || data?.state || "Unknown";

          if (status.toLowerCase() === "completed") {
            updateStatus("Integration completed.");
            await downloadDeliverable(env, processId);
            return;
          }

          if (["failed", "canceled", "error"].includes(status.toLowerCase())) {
            updateStatus(`Integration failed: ${status}`);
            return;
          }
        } catch (err) {
          console.warn("Status check failed:", err);
        }

        checks++;
        await new Promise(r => setTimeout(r, delay));
      }

      updateStatus("‚åõ Gave up waiting. Please check Workday manually.");
    }

    // === Step 5: Download Deliverable ===
    async function downloadDeliverable(env, processId) {
      try {
        const res = await fetch(`${env.launchUrl}/${processId}/output`, {
          headers: {
            Authorization: `Bearer ${accessToken}`,
            "X-Tenant": selectedEnv.toLowerCase()
          }
        });

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `workday_output_${Date.now()}.html`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        updateStatus("üì• File downloaded successfully.");
      } catch (err) {
        updateStatus("‚ö†Ô∏è Failed to download output.");
        console.error(err);
      }
    }

    // === Event Listeners ===
    loginBtn.addEventListener("click", startOAuthLogin);
    launchBtn.addEventListener("click", launchIntegration);

    window.addEventListener("message", (event) => {
      const { type, code } = event.data || {};
      if (type === "oauth-code" && code) {
        exchangeToken(code);
      }
    });
  </script>
</body>
</html>
